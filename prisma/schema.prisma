generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * -------------------- Enums --------------------
 */

enum Role {
  DOCTOR
  PATIENT
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum MeetingType {
  ONLINE
  OFFLINE
}

enum SlotStatus {
  AVAILABLE
  FULL
  UNAVAILABLE
}

enum TimeOfDay {
  MORNING
  EVENING
}


enum SchedulingStrategy {
  STREAM
  WAVE
}


/* -------------------- Core Models -------------------- */

enum AppointmentStatus {
  BOOKED
  CONFIRMED
  CANCELLED_BY_PATIENT
  CANCELLED_BY_DOCTOR
}

/**
 * -------------------- Core Models --------------------
 */


model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
  role  Role    @default(PATIENT)

  // Google OAuth support
  provider   String?
  providerId String?

  doctor  Doctor?
  patient Patient?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerId])
}

model Doctor {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio      String?
  isActive Boolean @default(true)

  specialties DoctorSpecialty[]
  services    DoctorService[]

  scheduleRules DoctorScheduleRule[]
  slots         AvailabilitySlot[]



  appointments Appointment[]

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  availabilitySessions   AvailabilitySession[]
  doctorDayOverrides     DoctorDayOverride[]
  doctorSessionOverrides DoctorSessionOverride[]
}

model Patient {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  gender       String?
  dob          DateTime?
  bloodGroup   String?
  phone        String?
  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * -------------------- Specialty & Service --------------------
 */

model Specialty {
  id   Int    @id @default(autoincrement())
  name String @unique

  doctors DoctorSpecialty[]
}

model Service {
  id   Int    @id @default(autoincrement())
  name String @unique

  doctors DoctorService[]
}

model DoctorSpecialty {
  doctorId    Int
  specialtyId Int

  doctor    Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@id([doctorId, specialtyId])
  @@index([specialtyId])
}

model DoctorService {
  doctorId  Int
  serviceId Int

  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([doctorId, serviceId])
  @@index([serviceId])
}

/**
 * -------------------- Clinic (for OFFLINE) --------------------
 */

model Clinic {
  id      Int     @id @default(autoincrement())
  name    String
  address String?
  city    String?

  rules DoctorScheduleRule[]
  slots AvailabilitySlot[]

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  availabilitySessions   AvailabilitySession[]
  doctorSessionOverrides DoctorSessionOverride[]
}

/**
 * -------------------- Schedule Rules (Recurring Template) --------------------
 * Store time as minutes since midnight.
 * 10:00 = 600, 13:00 = 780, 18:00 = 1080, 22:00 = 1320, 9:00 = 540, 11:30 = 690
 */

model DoctorScheduleRule {
  id          Int         @id @default(autoincrement())
  doctorId    Int
  clinicId    Int?
  meetingType MeetingType

  dayOfWeek DayOfWeek
  timeOfDay TimeOfDay

  startMinute Int
  endMinute   Int

  slotDurationMin Int     @default(15)
  capacityPerSlot Int     @default(1)
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctor Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  clinic Clinic? @relation(fields: [clinicId], references: [id])


  strategy         SchedulingStrategy @default(STREAM)

  // for simple wave
  waveEveryMin     Int?   // e.g. 60 (wave repeats every hour)
  waveCapacity     Int?   // e.g. 4  (how many patients in that wave block)

  // for advanced wave patterns
  wavePattern      Json?  // Postgres jsonb (Prisma Json)
  
  


  @@unique([doctorId, meetingType, dayOfWeek, timeOfDay, startMinute, endMinute])
  @@index([doctorId, dayOfWeek, isActive])
}

/**
 * -------------------- Generated Slots (Bookable) --------------------
 */

model AvailabilitySlot {
  id        Int @id @default(autoincrement())
  sessionId Int

  doctorId    Int
  clinicId    Int?
  meetingType MeetingType
  locationKey String      @default("NONE")

  date        DateTime
  startMinute Int
  endMinute   Int

  // ✅ add these (your index already expects status)
  status      SlotStatus @default(AVAILABLE)
  capacity    Int        @default(1)
  bookedCount Int        @default(0)

  session AvailabilitySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  doctor  Doctor              @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  clinic  Clinic?             @relation(fields: [clinicId], references: [id])

  // ✅ 1 appointment per slot
  appointment Appointment?

  @@unique([sessionId, startMinute])
  @@index([doctorId, date, status])
}

model AvailabilitySession {
  id          Int         @id @default(autoincrement())
  doctorId    Int
  clinicId    Int?
  meetingType MeetingType
  date        DateTime
  timeOfDay   TimeOfDay
  locationKey String

  startMinute Int
  endMinute   Int

  doctor            Doctor             @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  clinic            Clinic?            @relation(fields: [clinicId], references: [id])
  availabilitySlots AvailabilitySlot[]

  @@unique([doctorId, date, meetingType, timeOfDay, locationKey])
  @@index([doctorId, date, timeOfDay])
}

model DoctorDayOverride {
  id       Int      @id @default(autoincrement())
  doctorId Int
  date     DateTime // store the day (recommend normalize to start-of-day)
  isClosed Boolean  @default(false)
  note     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, date])
  @@index([doctorId, date])
}

model DoctorSessionOverride {
  id          Int         @id @default(autoincrement())
  doctorId    Int
  clinicId    Int?
  date        DateTime
  meetingType MeetingType
  timeOfDay   TimeOfDay
  locationKey String      @default("NONE")

  // if closed => remove/disable that date+session
  isClosed Boolean @default(false)

  // optional overrides (if null, fall back to rule values)
  startMinute     Int?
  endMinute       Int?
  slotDurationMin Int?
  capacityPerSlot Int?

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctor Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  clinic Clinic? @relation(fields: [clinicId], references: [id])

  @@unique([doctorId, date, meetingType, timeOfDay, locationKey])
  @@index([doctorId, date, timeOfDay])
}



/**
 * -------------------- Appointment Booking--------------------
 */

model Appointment {
  id Int @id @default(autoincrement())

  doctorId  Int
  patientId Int
  slotId    Int @unique // ✅ 1 appointment per slot

  status AppointmentStatus @default(BOOKED)

  note         String?
  cancelReason String?

  confirmedAt DateTime?
  cancelledAt DateTime?

  overrideDate        DateTime?
  overrideStartMinute Int?
  overrideEndMinute   Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctor  Doctor           @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  slot    AvailabilitySlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  @@index([doctorId, status])
  @@index([patientId, status])
}

