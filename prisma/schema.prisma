generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url is usually in env via DATABASE_URL
}

enum Role {
  DOCTOR
  PATIENT
}

/* ---- Availability enums ---- */
enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum MeetingType {
  ONLINE
  OFFLINE
}

enum SlotStatus {
  AVAILABLE
  FULL
  UNAVAILABLE
}

enum TimeOfDay {
  MORNING
  EVENING
}

/* ---- Core user models ---- */
model User {
  id    String  @id @default(uuid())
  email String  @unique
  name  String?
  role  Role    @default(PATIENT)

  doctor  Doctor?
  patient Patient?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Doctor {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio      String?
  isActive Boolean @default(true)

  specialties DoctorSpecialty[]
  services    DoctorService[]

  scheduleRules DoctorScheduleRule[]
  slots         AvailabilitySlot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Patient {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  gender     String?
  dob        DateTime?
  bloodGroup String?
  phone      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* ---- Metadata for UI (specialty/services/clinic) ---- */
model Specialty {
  id   String @id @default(uuid())
  name String @unique

  doctors DoctorSpecialty[]
}

model Service {
  id   String @id @default(uuid())
  name String @unique

  doctors DoctorService[]
}

model DoctorSpecialty {
  doctorId    String
  specialtyId String

  doctor    Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@id([doctorId, specialtyId])
}

model DoctorService {
  doctorId  String
  serviceId String

  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([doctorId, serviceId])
}

model Clinic {
  id      String  @id @default(uuid())
  name    String
  address String?
  city    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rules DoctorScheduleRule[]
  slots AvailabilitySlot[]
}

/* ---- Schedule template (Mon-Fri / Sat windows) ----
   Store times as minutes since midnight.
   10:00 = 600, 13:00 = 780, 18:00 = 1080, 22:00 = 1320, 9:00 = 540, 11:30 = 690
*/
model DoctorScheduleRule {
  id              String      @id @default(uuid())
  doctorId        String
  clinicId        String?
  meetingType     MeetingType

  dayOfWeek       DayOfWeek
  timeOfDay       TimeOfDay

  startMinute     Int
  endMinute       Int

  slotDurationMin Int         @default(15)
  capacityPerSlot Int         @default(1)
  isActive        Boolean     @default(true)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  doctor          Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  clinic          Clinic?     @relation(fields: [clinicId], references: [id])

  @@index([doctorId, dayOfWeek, isActive])
  @@unique([doctorId, meetingType, dayOfWeek, timeOfDay, startMinute, endMinute])
}

/* ---- Generated slots for a specific date (bookable) ---- */
model AvailabilitySlot {
  id          String      @id @default(uuid())
  doctorId    String
  clinicId    String?
  meetingType MeetingType

  date        DateTime    // normalize to day start (00:00)
  startMinute Int
  endMinute   Int
  timeOfDay   TimeOfDay

  capacity    Int         @default(1)
  bookedCount Int         @default(0)
  status      SlotStatus  @default(AVAILABLE)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  doctor      Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  clinic      Clinic?     @relation(fields: [clinicId], references: [id])

  @@unique([doctorId, date, meetingType, startMinute, endMinute])
  @@index([doctorId, date, status])
}
